#cloud-config
# Hetzner Cloud-init for Stream Overlay System
# Ubuntu 24.04 LTS
#
# Adjust before use:
# - DOMAIN, EMAIL, STREAMER_ID
# - PASSWORDS_JSON
# - (optional) update ssh_import_id with your GitHub user
#
# Usage:
# 1. Create a Hetzner Cloud server (Ubuntu 24.04)
# 2. Paste this file into cloud-init
# 3. Point the DNS A record to the server IP
# 4. After ~5-10 minutes the system is available
#
# Result: https://DOMAIN/<STREAMER_ID>/modoverlay

write_files:
  - path: /root/.overlay_config
    content: |
      DOMAIN="overlay.example.com"
      EMAIL="your-email@example.com"
      STREAMER_ID="derstrese"
      NODE_VERSION="20"
      PORT="3000"
      TRUST_PROXY="1"
      PASSWORDS_JSON='{"derstrese":"2627"}'
    permissions: '0600'

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - build-essential
  - ufw
  - fail2ban
  - htop
  - vim
  - net-tools
  - certbot
  - python3-certbot-nginx
  - nginx

users:
  - name: overlay
    groups: [sudo, www-data]
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_import_id:
      - gh:YOUR_GITHUB_USER

ssh_pwauth: false
disable_root: true

runcmd:
  - |
    set -euo pipefail
    source /root/.overlay_config

    timedatectl set-timezone Europe/Berlin

    echo "Configuring firewall..."
    ufw --force enable
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow 22/tcp comment 'SSH'
    ufw allow 80/tcp comment 'HTTP'
    ufw allow 443/tcp comment 'HTTPS'

    echo "Configuring Fail2Ban..."
    cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
    systemctl enable fail2ban
    systemctl start fail2ban

    echo "Installing Node.js ${NODE_VERSION}..."
    curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash -
    apt-get install -y nodejs
    node --version
    npm --version

    echo "Installing PM2..."
    npm install -g pm2
    pm2 startup systemd -u overlay --hp /home/overlay

    echo "Cloning repository..."
    su - overlay -c "cd ~ && git clone https://github.com/Floppy5004/stream-overlay-system.git"
    su - overlay -c "cd ~/stream-overlay-system && npm ci"

    echo "Configuring Nginx..."
    cat > /etc/nginx/sites-available/overlay << 'NGINXEOF'
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    upstream nodejs_backend {
        server 127.0.0.1:PORT_PLACEHOLDER;
        keepalive 64;
    }

    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

    server {
        listen 80;
        listen [::]:80;
        server_name DOMAIN_PLACEHOLDER;

        location /.well-known/acme-challenge/ {
            root /var/www/html;
        }

        location / {
            return 301 https://$server_name$request_uri;
        }
    }

    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name DOMAIN_PLACEHOLDER;

        # ssl_certificate /etc/letsencrypt/live/DOMAIN_PLACEHOLDER/fullchain.pem;
        # ssl_certificate_key /etc/letsencrypt/live/DOMAIN_PLACEHOLDER/privkey.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        client_max_body_size 200m;

        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        access_log /var/log/nginx/overlay_access.log;
        error_log /var/log/nginx/overlay_error.log;

        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss;

        location /socket.io/ {
            proxy_pass http://nodejs_backend;
            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_buffering off;
            proxy_cache_bypass $http_upgrade;
            proxy_redirect off;

            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
        }

        location /api/ {
            limit_req zone=api burst=50 nodelay;

            proxy_pass http://nodejs_backend;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            proxy_pass http://nodejs_backend;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        location / {
            limit_req zone=general burst=20 nodelay;

            proxy_pass http://nodejs_backend;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_buffering off;
            proxy_cache_bypass $http_upgrade;
            proxy_redirect off;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }
    NGINXEOF

    sed -i "s/DOMAIN_PLACEHOLDER/${DOMAIN}/g" /etc/nginx/sites-available/overlay
    sed -i "s/PORT_PLACEHOLDER/${PORT}/g" /etc/nginx/sites-available/overlay

    rm -f /etc/nginx/sites-enabled/default
    ln -sf /etc/nginx/sites-available/overlay /etc/nginx/sites-enabled/
    nginx -t
    systemctl reload nginx

    echo "Waiting for DNS..."
    sleep 10
    echo "Requesting SSL certificate..."
    certbot --nginx -d ${DOMAIN} --non-interactive --agree-tos --email ${EMAIL} --redirect || echo "SSL issuance failed. Run: sudo certbot --nginx -d ${DOMAIN}"

    echo "Creating PM2 ecosystem config..."
    cat > /home/overlay/stream-overlay-system/ecosystem.config.js << 'PM2EOF'
    module.exports = {
      apps: [{
        name: 'stream-overlay',
        script: './server.js',
        cwd: '/home/overlay/stream-overlay-system',
        instances: 1,
        autorestart: true,
        watch: false,
        max_memory_restart: '1G',
        env: {
          NODE_ENV: 'production'
        },
        error_file: '/home/overlay/.pm2/logs/stream-overlay-error.log',
        out_file: '/home/overlay/.pm2/logs/stream-overlay-out.log',
        log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
        merge_logs: true
      }]
    };
    PM2EOF

    cp /root/.overlay_config /home/overlay/.overlay_config
    chown overlay:overlay /home/overlay/.overlay_config
    chmod 600 /home/overlay/.overlay_config

    chown overlay:overlay /home/overlay/stream-overlay-system/ecosystem.config.js

    su - overlay -c "set -a; source ~/.overlay_config; set +a; cd ~/stream-overlay-system && pm2 start ecosystem.config.js"
    su - overlay -c "pm2 save"
    systemctl enable pm2-overlay

    echo "Setting up healthcheck..."
    cat > /usr/local/bin/overlay-healthcheck.sh << 'HCHECK'
    #!/usr/bin/env bash
    set -euo pipefail
    source /root/.overlay_config
    if ! curl -fsS "http://127.0.0.1:${PORT}/health" >/dev/null; then
        logger -t overlay-healthcheck "Healthcheck failed, restarting PM2 app"
        su - overlay -c "pm2 restart stream-overlay"
    else
        logger -t overlay-healthcheck "Healthcheck ok"
    fi
    HCHECK
    chmod +x /usr/local/bin/overlay-healthcheck.sh

    cat > /etc/systemd/system/overlay-healthcheck.service << 'SVC'
    [Unit]
    Description=Stream Overlay Healthcheck

    [Service]
    Type=oneshot
    ExecStart=/usr/local/bin/overlay-healthcheck.sh
    SVC

    cat > /etc/systemd/system/overlay-healthcheck.timer << 'TMR'
    [Unit]
    Description=Run Stream Overlay Healthcheck every minute

    [Timer]
    OnBootSec=90s
    OnUnitActiveSec=60s
    AccuracySec=10s
    Unit=overlay-healthcheck.service

    [Install]
    WantedBy=timers.target
    TMR

    systemctl daemon-reload
    systemctl enable --now overlay-healthcheck.timer

    echo "Configuring unattended upgrades..."
    apt-get install -y unattended-upgrades
    dpkg-reconfigure -f noninteractive unattended-upgrades

    systemctl enable certbot.timer
    systemctl start certbot.timer

    cat > /root/server_info.txt << INFOEOF
    ========================================
    STREAM OVERLAY SYSTEM
    ========================================

    URL:
      https://${DOMAIN}

    Mod UI:
      https://${DOMAIN}/${STREAMER_ID}/modoverlay

    Overlay:
      https://${DOMAIN}/${STREAMER_ID}/overlay-display

    SSH:
      user: overlay (SSH key only)

    PM2:
      pm2 status
      pm2 logs stream-overlay
      pm2 restart stream-overlay

    Nginx:
      sudo nginx -t
      sudo systemctl reload nginx

    SSL:
      sudo certbot renew
      sudo certbot renew --dry-run

    Logs:
      PM2: ~/.pm2/logs/
      Nginx: /var/log/nginx/

    IMPORTANT:
    - Ensure DNS A record for ${DOMAIN} points to this server.
    - If SSL failed: sudo certbot --nginx -d ${DOMAIN}

    ========================================
    INFOEOF

    cat /root/server_info.txt

    echo "Installation done."
    sleep 5
    reboot

power_state:
  delay: now
  mode: reboot
  message: "Stream Overlay System setup completed - rebooting..."
  timeout: 30
  condition: true

final_message: |
  ========================================
  Stream Overlay System Installation
  ========================================
  Setup completed.

  Access:
    https://DOMAIN

  More info: /root/server_info.txt
  ========================================
